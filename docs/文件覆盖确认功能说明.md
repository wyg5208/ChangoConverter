# 文件覆盖确认功能说明 v1.2.0

## 📋 功能概述

当转换生成的文件已经存在时，系统会弹出确认对话框，让用户选择如何处理，避免意外覆盖重要文件。

## ✨ 核心功能

### 1. 智能文件检测

**检测时机**：
- 在执行文件转换之前
- 检查目标文件是否已存在
- 单文件模式和批量模式都支持

**检测范围**：
- 所有输出格式的目标文件
- 包括DOCX、HTML、PDF、TXT等所有格式

### 2. 三种处理方式

用户可以选择以下三种处理方式：

#### ① 覆盖现有文件
```
[●] 覆盖现有文件 (将删除原文件)
[ ] 重命名新文件 (添加数字后缀，如 file_1.docx)
[ ] 跳过此文件 (不转换)
```

- **操作**：删除原文件，生成新文件
- **适用场景**：确认要更新文件
- **日志显示**：`⚠️ 将覆盖现有文件`

#### ② 重命名新文件
```
[ ] 覆盖现有文件 (将删除原文件)
[●] 重命名新文件 (添加数字后缀，如 file_1.docx)
[ ] 跳过此文件 (不转换)
```

- **操作**：自动添加数字后缀，生成唯一文件名
- **命名规则**：`原文件名_1.扩展名`、`原文件名_2.扩展名`...
- **示例**：
  - `document.docx` 存在 → 生成 `document_1.docx`
  - `document_1.docx` 也存在 → 生成 `document_2.docx`
- **适用场景**：保留原文件和新文件
- **日志显示**：`📝 重命名为: document_1.docx`

#### ③ 跳过此文件
```
[ ] 覆盖现有文件 (将删除原文件)
[ ] 重命名新文件 (添加数字后缀，如 file_1.docx)
[●] 跳过此文件 (不转换)
```

- **操作**：不进行转换，保持原文件不变
- **适用场景**：不需要转换此文件
- **日志显示**：`⊘ 跳过 docx (文件已存在)`

### 3. 记住选择功能

```
☑ 记住我的选择，后续相同问题使用相同方式处理
```

**功能说明**：
- 勾选后，后续遇到文件冲突时自动应用相同策略
- 不再弹出对话框，直接按之前的选择处理
- 适用于批量转换大量文件的场景

**作用域**：
- 仅在当前转换任务中有效
- 新的转换任务会重置策略
- 确保每次转换都能重新选择

## 🎨 对话框界面

### 界面布局

```
┌─────────────────────────────────────────────────────┐
│  文件已存在                                         │
├─────────────────────────────────────────────────────┤
│                                                      │
│  ⚠️   文件已存在                                    │
│        document.docx                                │
│        请选择如何处理：                             │
│                                                      │
│  ┌─────────────────────────────────────────────┐   │
│  │ 处理方式                                    │   │
│  │                                              │   │
│  │  ○ 覆盖现有文件 (将删除原文件)             │   │
│  │  ● 重命名新文件 (添加数字后缀)             │   │
│  │  ○ 跳过此文件 (不转换)                     │   │
│  │                                              │   │
│  └─────────────────────────────────────────────┘   │
│                                                      │
│  ☐ 记住我的选择，后续相同问题使用相同方式处理      │
│                                                      │
│                               [取消]  [确定]        │
└─────────────────────────────────────────────────────┘
```

### 界面特点

- **警告图标**：⚠️ 醒目的图标提示用户注意
- **文件名高亮**：蓝色显示文件名，易于识别
- **单选按钮**：清晰的三选一选项
- **详细说明**：每个选项都有说明文字
- **记住选择**：可选的复选框
- **标准按钮**：确定和取消按钮

## 📊 使用场景

### 场景1：单文件转换（首次）

**操作流程**：
1. 选择"单文件转换"
2. 选择输入文件：`report.md`
3. 选择输出格式：DOCX、HTML
4. 点击"▶ 开始转换"
5. 如果`report.docx`已存在，弹出对话框

**对话框选择**：
- 选择"覆盖现有文件"
- ☑ 勾选"记住我的选择"
- 点击"确定"

**结果**：
- `report.docx` 被覆盖
- `report.html` 如果也存在，自动覆盖（不再询问）

### 场景2：批量转换（记住选择）

**操作流程**：
1. 选择"批量转换（文件夹）"
2. 选择包含50个Markdown文件的文件夹
3. 选择输出格式：DOCX
4. 点击"▶ 开始转换"
5. 第1个文件已存在，弹出对话框

**第一次选择**：
- 选择"重命名新文件"
- ☑ 勾选"记住我的选择"
- 点击"确定"

**后续处理**：
- 第2-50个文件如果存在，自动重命名
- 不再弹出对话框
- 生成：`file_1.docx`、`file2_1.docx`等

**日志显示**：
```
[1/50] (2.0%) 处理: file1.md
    [1/1] 📝 重命名为: file1_1.docx
    ✓ 转换成功 → file1_1.docx

[2/50] (4.0%) 处理: file2.md
    [1/1] 📝 重命名为: file2_1.docx
    ✓ 转换成功 → file2_1.docx

[3/50] (6.0%) 处理: file3.md
    [1/1] ⏳ 正在转换到 DOCX...
    ✓ 转换成功 → file3.docx
```

### 场景3：跳过已存在的文件

**使用场景**：
- 增量转换：只转换新文件或修改过的文件
- 避免重复工作：已转换的文件不再处理

**操作**：
- 选择"跳过此文件"
- ☑ 勾选"记住我的选择"

**效果**：
- 所有已存在的文件都被跳过
- 只转换新文件
- 大幅节省时间

### 场景4：混合处理（不记住选择）

**操作**：
- 每次都不勾选"记住我的选择"
- 每个文件单独决定

**效果**：
- 文件A：选择覆盖
- 文件B：选择重命名
- 文件C：选择跳过
- 灵活控制每个文件的处理方式

## 🔧 技术实现

### 1. 检测逻辑

**检测代码**：
```python
# 生成输出文件路径
output_file = os.path.join(output_dir, f"{base_name}.{ext}")

# 检查文件是否存在
if os.path.exists(output_file):
    # 显示对话框获取用户选择
    action = self.show_file_exists_dialog(output_file)
    
    if action == 'skip':
        # 跳过转换
        continue
    elif action == 'rename':
        # 生成唯一文件名
        output_file = self.get_unique_filename(output_file)
    elif action == 'overwrite':
        # 继续使用原路径（将覆盖）
        pass
```

### 2. 唯一文件名生成

**算法**：
```python
def get_unique_filename(self, filepath):
    """生成唯一的文件名（添加数字后缀）"""
    directory = os.path.dirname(filepath)
    name, ext = os.path.splitext(os.path.basename(filepath))
    
    counter = 1
    while True:
        new_filename = f"{name}_{counter}{ext}"
        new_filepath = os.path.join(directory, new_filename)
        if not os.path.exists(new_filepath):
            return new_filepath
        counter += 1
```

**示例**：
- `document.docx` 存在
- 检查 `document_1.docx` → 不存在，返回
- 如果存在，继续检查 `document_2.docx`
- 直到找到不存在的文件名

### 3. 策略记忆机制

**状态变量**：
```python
self.file_overwrite_policy = None  # 'overwrite', 'rename', 'skip', None
self.remember_choice = False       # True/False
```

**逻辑**：
```python
def show_file_exists_dialog(self, filename):
    # 如果已经记住了选择，直接返回
    if self.remember_choice and self.file_overwrite_policy:
        return self.file_overwrite_policy
    
    # 否则显示对话框
    # ... 对话框代码 ...
    
    # 如果用户勾选了"记住选择"
    if remember_var.get():
        self.file_overwrite_policy = choice_var.get()
        self.remember_choice = True
```

**重置时机**：
```python
# 每次开始新的转换任务时重置
self.file_overwrite_policy = None
self.remember_choice = False
```

### 4. 线程安全处理

**问题**：转换在后台线程执行，但对话框必须在主线程显示

**解决方案**：
```python
# 在后台线程中
self.root.after(0, lambda: self._set_file_action(output_file))

# 等待主线程处理完成
while not hasattr(self, '_temp_file_action'):
    time.sleep(0.1)

action = self._temp_file_action
delattr(self, '_temp_file_action')

# 在主线程中
def _set_file_action(self, filepath):
    action = self.show_file_exists_dialog(filepath)
    self._temp_file_action = action
```

## 📝 日志输出示例

### 覆盖模式

```
[1/3] (33.3%) 处理: document.md
    📂 路径: D:/Docs/document.md
    📄 格式: markdown
    [1/2] (50%) ⏳ 正在转换到 DOCX...
        ⚠️ 将覆盖现有文件
        🔧 正在应用DOCX字体设置...
        ✓ 字体设置完成
        ✓ 转换成功 → document.docx
    [2/2] (100%) ⏳ 正在转换到 HTML5...
        ✓ 转换成功 → document.html
```

### 重命名模式

```
[2/3] (66.7%) 处理: report.md
    📂 路径: D:/Docs/report.md
    📄 格式: markdown
    [1/2] (50%) 📝 重命名为: report_1.docx
    [1/2] (50%) ⏳ 正在转换到 DOCX...
        ✓ 转换成功 → report_1.docx
    [2/2] (100%) ⏳ 正在转换到 HTML5...
        ✓ 转换成功 → report.html
```

### 跳过模式

```
[3/3] (100.0%) 处理: readme.md
    📂 路径: D:/Docs/readme.md
    📄 格式: markdown
    [1/2] ⊘ 跳过 docx (文件已存在)
    [2/2] (100%) ⏳ 正在转换到 HTML5...
        ✓ 转换成功 → readme.html
```

## 💡 使用建议

### 建议1：批量转换时使用"记住选择"

**原因**：
- 避免对每个文件都弹出对话框
- 提高批量转换效率
- 保持处理策略一致

**操作**：
- 第一个文件弹出对话框时
- 决定整体策略
- ☑ 勾选"记住我的选择"

### 建议2：不确定时选择"重命名"

**原因**：
- 安全：不会删除原文件
- 保留所有版本
- 可以稍后对比和清理

**场景**：
- 不确定原文件是否还需要
- 需要对比新旧版本
- 作为备份策略

### 建议3：增量转换时选择"跳过"

**原因**：
- 只处理新文件或修改过的文件
- 节省时间
- 避免不必要的转换

**场景**：
- 定期转换整个文档库
- 只更新了部分文件
- 不想重新转换所有文件

### 建议4：确认更新时选择"覆盖"

**原因**：
- 文件名保持不变
- 替换旧版本
- 保持目录整洁

**场景**：
- 确认要更新文件
- 旧版本已经不需要
- 避免产生多个版本

## ⚠️ 注意事项

### 1. 覆盖操作不可逆

**警告**：
- 覆盖后原文件无法恢复
- 建议重要文件先备份
- 或选择"重命名"保留原文件

### 2. 策略重置

**说明**：
- 每次新的转换任务会重置策略
- 不会影响之后的转换
- 确保每次都能重新选择

### 3. 重命名文件累积

**现象**：
- 多次转换会产生`file_1.docx`、`file_2.docx`等
- 需要定期清理

**建议**：
- 定期检查和清理旧版本
- 或使用"覆盖"模式

### 4. 跳过后无法撤销

**说明**：
- 跳过的文件不会被转换
- 如果误选了"跳过"并记住选择
- 需要重新开始转换任务

## 📊 功能对比

### 优化前 vs 优化后

| 功能 | 优化前 | 优化后 |
|------|--------|--------|
| 文件冲突处理 | 直接覆盖，无提示 | 弹出对话框，用户选择 ✓ |
| 处理方式 | 只能覆盖 | 覆盖/重命名/跳过 三选一 ✓ |
| 批量处理 | 每个都覆盖 | 可记住选择，统一处理 ✓ |
| 安全性 | 可能误删重要文件 | 用户确认，更安全 ✓ |
| 灵活性 | 无选择 | 多种策略，灵活应对 ✓ |
| 增量转换 | 不支持 | 支持跳过已存在文件 ✓ |

## 🎯 应用场景总结

### 1. 首次转换（建议：覆盖）
- 第一次转换文件
- 不存在冲突问题
- 生成全新文件

### 2. 更新转换（建议：覆盖 + 记住选择）
- 更新已转换的文件
- 确认要替换旧版本
- 批量更新整个文档库

### 3. 保留版本（建议：重命名 + 记住选择）
- 保留原文件和新文件
- 对比新旧版本
- 作为备份策略

### 4. 增量转换（建议：跳过 + 记住选择）
- 只转换新文件
- 跳过已转换的文件
- 节省转换时间

### 5. 精细控制（建议：不记住选择）
- 每个文件单独决定
- 灵活处理不同文件
- 需要人工判断

---

**版本**: v1.2.0  
**更新日期**: 2024-10-23  
**新增功能**: 文件覆盖确认对话框  

**让文件转换更安全、更灵活！** 🛡️



